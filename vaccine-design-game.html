<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaccine Design Game - How Vaccines Work</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
        // Game States
        const STATES = {
            INTRO: 'intro',
            VIRUS_LEARN: 'virus_learn',
            IMMUNE_LEARN: 'immune_learn',
            DESIGN_PUZZLE: 'design_puzzle',
            SIMULATION: 'simulation',
            RESULTS: 'results'
        };

        let gameState = STATES.INTRO;
        let currentPage = 0;

        // Virus and Vaccine Data
        let virus = {
            x: 0, y: 0,
            antigens: [], // Shape patterns that need to be matched
            color: null
        };

        let vaccineDesign = {
            antibodies: [],
            effectiveness: 0
        };

        // Draggable antibody pieces for puzzle
        let antibodyPieces = [];
        let selectedPiece = null;
        let dragOffset = { x: 0, y: 0 };

        // Simulation variables
        let immuneCells = [];
        let invadingViruses = [];
        let antibodies = [];
        let simulationTime = 0;
        let virusesBlocked = 0;
        let virusesEscaped = 0;

        // Button
        let nextButton;

        function setup() {
            let canvas = createCanvas(900, 700);
            canvas.parent('game-container');

            // Initialize virus with random antigens
            initializeVirus();

            // Create antibody pieces for puzzle
            createAntibodyPieces();

            textAlign(CENTER, CENTER);
            textSize(16);
        }

        function draw() {
            background(240, 248, 255);

            switch(gameState) {
                case STATES.INTRO:
                    drawIntro();
                    break;
                case STATES.VIRUS_LEARN:
                    drawVirusLearn();
                    break;
                case STATES.IMMUNE_LEARN:
                    drawImmuneLearn();
                    break;
                case STATES.DESIGN_PUZZLE:
                    drawDesignPuzzle();
                    break;
                case STATES.SIMULATION:
                    drawSimulation();
                    break;
                case STATES.RESULTS:
                    drawResults();
                    break;
            }
        }

        function drawIntro() {
            // Title
            fill(70, 70, 130);
            textSize(48);
            textStyle(BOLD);
            text("üíâ Vaccine Design Lab", width/2, 100);

            textStyle(NORMAL);
            textSize(24);
            fill(100);
            text("Learn How Vaccines Work!", width/2, 160);

            // Info box
            fill(255);
            stroke(70, 70, 130);
            strokeWeight(3);
            rect(100, 220, 700, 300, 20);

            fill(50);
            textSize(20);
            textAlign(LEFT);
            text("Welcome, Future Vaccine Designer!", 140, 260);

            textSize(16);
            let infoText = [
                "In this game, you'll learn:",
                "",
                "ü¶† How viruses invade our bodies",
                "üõ°Ô∏è How our immune system fights back",
                "üß¨ How scientists design vaccines",
                "üéØ How antibodies match viral antigens",
                "",
                "Your mission: Design a vaccine to protect against a deadly virus!"
            ];

            for (let i = 0; i < infoText.length; i++) {
                text(infoText[i], 140, 300 + i * 28);
            }

            // Start button
            textAlign(CENTER, CENTER);
            drawButton("Start Learning!", width/2, 580, 250, 60, color(76, 175, 80));
        }

        function drawVirusLearn() {
            fill(70, 70, 130);
            textSize(36);
            textStyle(BOLD);
            text("Understanding Viruses", width/2, 50);

            // Animated virus
            textStyle(NORMAL);
            let virusX = width/2;
            let virusY = 200;
            drawVirus(virusX, virusY, 80, virus.antigens, virus.color);

            // Info box
            fill(255);
            stroke(70, 70, 130);
            strokeWeight(2);
            rect(100, 320, 700, 280, 15);

            fill(50);
            textSize(18);
            textAlign(LEFT);
            let virusInfo = [
                "ü¶† Viruses are tiny invaders that can make us sick.",
                "",
                "üîë The SPIKE PROTEINS (antigens) on their surface are like keys",
                "   that unlock our cells and let the virus get inside.",
                "",
                "‚ö†Ô∏è Once inside, viruses hijack our cells to make copies of themselves,",
                "   spreading the infection throughout our body.",
                "",
                "üí° To stop them, we need to block those spike proteins!"
            ];

            for (let i = 0; i < virusInfo.length; i++) {
                text(virusInfo[i], 120, 345 + i * 30);
            }

            // Highlight antigens with arrows
            fill(255, 100, 100);
            textSize(14);
            textAlign(CENTER);
            text("Spike Proteins\n(Antigens)", virusX + 120, virusY - 50);
            stroke(255, 100, 100);
            strokeWeight(2);
            drawArrow(virusX + 100, virusY - 30, virusX + 70, virusY - 40);

            textAlign(CENTER, CENTER);
            drawButton("Next: The Immune System", width/2, 640, 280, 50, color(76, 175, 80));
        }

        function drawImmuneLearn() {
            fill(70, 70, 130);
            textSize(36);
            textStyle(BOLD);
            text("Your Immune System", width/2, 50);

            textStyle(NORMAL);

            // Draw immune cells
            let cellY = 180;

            // B-Cell
            push();
            fill(100, 200, 255);
            stroke(50);
            strokeWeight(2);
            circle(200, cellY, 80);
            fill(255);
            textSize(24);
            text("üõ°Ô∏è", 200, cellY);
            fill(50);
            textSize(16);
            text("B-Cell", 200, cellY + 70);
            pop();

            // Arrow
            stroke(100);
            strokeWeight(3);
            drawArrow(250, cellY, 320, cellY);
            fill(100);
            textSize(14);
            text("produces", 285, cellY - 20);

            // Antibody
            push();
            fill(255, 200, 100);
            stroke(50);
            strokeWeight(2);
            drawAntibody(380, cellY, 40, virus.antigens[0]);
            fill(50);
            textSize(16);
            text("Antibody", 380, cellY + 70);
            pop();

            // Arrow
            stroke(100);
            strokeWeight(3);
            drawArrow(430, cellY, 500, cellY);
            fill(100);
            textSize(14);
            text("binds to", 465, cellY - 20);

            // Virus
            drawVirus(600, cellY, 60, virus.antigens, virus.color);
            fill(50);
            textSize(16);
            text("Blocked Virus!", 600, cellY + 70);

            // Info box
            fill(255);
            stroke(70, 70, 130);
            strokeWeight(2);
            rect(100, 300, 700, 280, 15);

            fill(50);
            textSize(18);
            textAlign(LEFT);
            let immuneInfo = [
                "üõ°Ô∏è Your immune system has special cells called B-CELLS that",
                "   produce ANTIBODIES - proteins that stick to viruses.",
                "",
                "üîí Antibodies are shaped to fit perfectly onto the virus's spike proteins,",
                "   like a lock and key. This blocks the virus from entering cells!",
                "",
                "‚è±Ô∏è Problem: It takes days for your body to learn to make the right",
                "   antibodies. That's where vaccines come in!",
                ""
            ];

            for (let i = 0; i < immuneInfo.length; i++) {
                text(immuneInfo[i], 120, 325 + i * 30);
            }

            textAlign(CENTER, CENTER);
            drawButton("Next: Design a Vaccine!", width/2, 640, 280, 50, color(255, 140, 0));
        }

        function drawDesignPuzzle() {
            fill(70, 70, 130);
            textSize(32);
            textStyle(BOLD);
            text("üß¨ Vaccine Design Puzzle", width/2, 40);

            textStyle(NORMAL);
            textSize(16);
            fill(100);
            text("Match antibody shapes to the virus's spike proteins!", width/2, 75);

            // Virus to target
            push();
            fill(255);
            stroke(200, 100, 100);
            strokeWeight(3);
            rect(50, 110, 300, 220, 15);
            fill(50);
            textSize(18);
            textStyle(BOLD);
            text("Target Virus", 200, 130);
            textStyle(NORMAL);
            drawVirus(200, 220, 70, virus.antigens, virus.color);
            pop();

            // Antibody toolbox
            push();
            fill(255);
            stroke(100, 150, 250);
            strokeWeight(3);
            rect(50, 350, 300, 320, 15);
            fill(50);
            textSize(18);
            textStyle(BOLD);
            text("Antibody Pieces (Drag to Design Area)", 200, 370);
            textStyle(NORMAL);

            // Draw available antibody pieces
            for (let piece of antibodyPieces) {
                if (!piece.placed) {
                    piece.display();
                }
            }
            pop();

            // Design area
            push();
            fill(255);
            stroke(100, 200, 100);
            strokeWeight(3);
            rect(380, 110, 470, 560, 15);
            fill(50);
            textSize(18);
            textStyle(BOLD);
            text("Your Vaccine Design", 615, 130);
            textStyle(NORMAL);
            textSize(14);
            fill(100);
            text("Drag antibody pieces here. Match the shapes to the virus antigens!", 615, 155);

            // Show design slots
            for (let i = 0; i < virus.antigens.length; i++) {
                let slotX = 480 + (i % 3) * 130;
                let slotY = 200 + Math.floor(i / 3) * 150;

                // Slot
                fill(245);
                stroke(150);
                strokeWeight(2);
                rect(slotX, slotY, 100, 100, 10);

                // Show target shape
                fill(200);
                textSize(12);
                text(`Antigen ${i+1}`, slotX + 50, slotY + 15);

                // Draw target shape
                push();
                translate(slotX + 50, slotY + 50);
                scale(0.5);
                drawAntigenShape(0, 0, 30, virus.antigens[i]);
                pop();

                // Check if antibody is placed
                let placedAntibody = antibodyPieces.find(p => p.placed && p.slotIndex === i);
                if (placedAntibody) {
                    placedAntibody.display();
                }
            }
            pop();

            // Calculate effectiveness
            calculateVaccineEffectiveness();

            // Show effectiveness meter
            push();
            fill(255);
            stroke(70, 70, 130);
            strokeWeight(2);
            rect(380, 520, 470, 80, 15);

            fill(50);
            textSize(18);
            textStyle(BOLD);
            text("Vaccine Effectiveness: " + vaccineDesign.effectiveness + "%", 615, 540);

            // Effectiveness bar
            let barWidth = 400;
            let barHeight = 25;
            let barX = 615 - barWidth/2;
            let barY = 560;

            fill(230);
            stroke(100);
            strokeWeight(2);
            rect(barX, barY, barWidth, barHeight, 5);

            let fillWidth = (vaccineDesign.effectiveness / 100) * barWidth;
            let barColor;
            if (vaccineDesign.effectiveness < 40) barColor = color(255, 100, 100);
            else if (vaccineDesign.effectiveness < 70) barColor = color(255, 200, 100);
            else barColor = color(100, 255, 100);

            fill(barColor);
            noStroke();
            rect(barX, barY, fillWidth, barHeight, 5);
            pop();

            // Test button
            if (vaccineDesign.effectiveness > 0) {
                drawButton("Test Vaccine in Simulation!", 615, 640, 300, 50,
                          vaccineDesign.effectiveness >= 70 ? color(76, 175, 80) : color(255, 152, 0));
            } else {
                fill(200);
                stroke(150);
                strokeWeight(2);
                rect(615 - 150, 615, 300, 50, 10);
                fill(150);
                textSize(16);
                text("Drag antibodies to design area", 615, 640);
            }
        }

        function drawSimulation() {
            fill(70, 70, 130);
            textSize(32);
            textStyle(BOLD);
            text("üß™ Vaccine Simulation", width/2, 40);

            textStyle(NORMAL);
            textSize(16);
            fill(100);

            if (simulationTime < 300) {
                text("Watch how your vaccine protects the body!", width/2, 75);
            }

            // Simulation area
            fill(255);
            stroke(100);
            strokeWeight(2);
            rect(50, 100, 800, 450, 10);

            // Stats
            fill(50);
            textSize(18);
            textAlign(LEFT);
            text("‚úÖ Viruses Blocked: " + virusesBlocked, 70, 130);
            text("‚ùå Viruses Escaped: " + virusesEscaped, 70, 160);

            // Run simulation
            if (simulationTime < 600) {
                updateSimulation();
                simulationTime++;
            }

            // Draw simulation elements
            for (let antibody of antibodies) {
                antibody.display();
                antibody.update();
            }

            for (let i = invadingViruses.length - 1; i >= 0; i--) {
                let v = invadingViruses[i];
                v.display();
                v.update();

                // Check collision with antibodies
                let blocked = false;
                for (let j = antibodies.length - 1; j >= 0; j--) {
                    let a = antibodies[j];
                    let d = dist(v.x, v.y, a.x, a.y);
                    if (d < 40 && !a.attached) {
                        // Check if shapes match
                        if (shapesMatch(v.antigenIndex, a.shapeIndex)) {
                            a.attached = true;
                            a.target = v;
                            blocked = true;
                            virusesBlocked++;

                            // Remove virus
                            invadingViruses.splice(i, 1);
                            break;
                        }
                    }
                }

                // Check if virus escaped
                if (!blocked && v.x > width - 50) {
                    virusesEscaped++;
                    invadingViruses.splice(i, 1);
                }
            }

            // Info text
            textAlign(CENTER);
            if (simulationTime < 100) {
                fill(100, 150, 255);
                textSize(20);
                text("Viruses are invading! ‚Üí", width/2, 500);
            } else if (simulationTime < 200) {
                fill(255, 150, 100);
                textSize(20);
                text("Your antibodies are responding! üõ°Ô∏è", width/2, 500);
            }

            // Done button
            if (simulationTime >= 600) {
                fill(76, 175, 80);
                textSize(22);
                text("Simulation Complete!", width/2, 500);
                drawButton("See Results", width/2, 620, 200, 50, color(76, 175, 80));
            }

            textAlign(CENTER, CENTER);
        }

        function drawResults() {
            fill(70, 70, 130);
            textSize(42);
            textStyle(BOLD);
            text("üéâ Results", width/2, 70);

            // Results box
            fill(255);
            stroke(70, 70, 130);
            strokeWeight(3);
            rect(100, 130, 700, 450, 20);

            textStyle(NORMAL);
            fill(50);
            textSize(24);
            text("Vaccine Effectiveness: " + vaccineDesign.effectiveness + "%", width/2, 180);

            textSize(20);
            let totalViruses = virusesBlocked + virusesEscaped;
            let blockRate = totalViruses > 0 ? Math.round((virusesBlocked / totalViruses) * 100) : 0;

            text("Blocked: " + virusesBlocked + " | Escaped: " + virusesEscaped, width/2, 220);
            text("Success Rate: " + blockRate + "%", width/2, 250);

            // Feedback
            textSize(18);
            textAlign(LEFT);
            let feedback = [];

            if (vaccineDesign.effectiveness >= 90) {
                fill(50, 150, 50);
                textSize(28);
                textAlign(CENTER);
                text("üèÜ Excellent Work! Perfect Vaccine Design!", width/2, 300);
                textSize(18);
                feedback = [
                    "",
                    "Your antibodies matched the viral antigens perfectly!",
                    "This is how real vaccines work - they train your immune",
                    "system to recognize specific parts of viruses.",
                    "",
                    "With your vaccine, the immune system can respond quickly",
                    "and block viruses before they cause disease!"
                ];
            } else if (vaccineDesign.effectiveness >= 70) {
                fill(200, 150, 0);
                textSize(26);
                textAlign(CENTER);
                text("ü•à Good Job! Effective Vaccine!", width/2, 300);
                textSize(18);
                feedback = [
                    "",
                    "Your vaccine provides good protection, though some viruses",
                    "got through. In real life, vaccines with 70-90% effectiveness",
                    "are still very useful for preventing disease!",
                    "",
                    "Try to match antibody shapes even more precisely to the",
                    "viral antigens for better protection."
                ];
            } else if (vaccineDesign.effectiveness >= 40) {
                fill(200, 100, 0);
                textSize(26);
                textAlign(CENTER);
                text("ü•â Partial Protection", width/2, 300);
                textSize(18);
                feedback = [
                    "",
                    "Your vaccine provides some protection, but many viruses",
                    "escaped. The antibody shapes don't match well enough",
                    "to the viral antigens.",
                    "",
                    "Scientists work hard to design vaccines where the antibodies",
                    "fit precisely onto the virus's spike proteins!"
                ];
            } else {
                fill(200, 50, 50);
                textSize(26);
                textAlign(CENTER);
                text("‚ùå Try Again!", width/2, 300);
                textSize(18);
                feedback = [
                    "",
                    "Your vaccine didn't provide much protection. The antibody",
                    "shapes don't match the viral antigens well.",
                    "",
                    "Remember: Vaccines work by teaching your immune system",
                    "to make antibodies that fit perfectly onto the virus's",
                    "spike proteins, blocking them from infecting cells!"
                ];
            }

            for (let i = 0; i < feedback.length; i++) {
                text(feedback[i], 130, 340 + i * 25);
            }

            // Buttons
            textAlign(CENTER, CENTER);
            drawButton("Try Different Design", width/2 - 150, 620, 220, 50, color(100, 150, 255));
            drawButton("Restart", width/2 + 150, 620, 150, 50, color(150, 150, 150));
        }

        // Helper Functions

        function initializeVirus() {
            virus.x = width / 2;
            virus.y = 200;
            virus.color = color(220, 80, 80);

            // Create 4-6 random antigen shapes
            let numAntigens = int(random(4, 7));
            virus.antigens = [];
            for (let i = 0; i < numAntigens; i++) {
                virus.antigens.push(int(random(0, 6))); // 6 different shape types
            }
        }

        function createAntibodyPieces() {
            antibodyPieces = [];
            let startX = 80;
            let startY = 410;

            // Create 2 copies of each antigen shape + some wrong ones
            for (let i = 0; i < virus.antigens.length; i++) {
                for (let copy = 0; copy < 2; copy++) {
                    let x = startX + (antibodyPieces.length % 3) * 90;
                    let y = startY + Math.floor(antibodyPieces.length / 3) * 90;
                    antibodyPieces.push(new AntibodyPiece(x, y, virus.antigens[i], i));
                }
            }

            // Add some incorrect shapes
            for (let i = 0; i < 4; i++) {
                let wrongShape = int(random(0, 6));
                while (virus.antigens.includes(wrongShape)) {
                    wrongShape = int(random(0, 6));
                }
                let x = startX + (antibodyPieces.length % 3) * 90;
                let y = startY + Math.floor(antibodyPieces.length / 3) * 90;
                antibodyPieces.push(new AntibodyPiece(x, y, wrongShape, -1));
            }

            // Shuffle
            antibodyPieces = shuffle(antibodyPieces);
        }

        function drawVirus(x, y, size, antigens, col) {
            push();
            translate(x, y);

            // Virus body
            fill(col);
            stroke(150, 50, 50);
            strokeWeight(2);
            circle(0, 0, size);

            // Draw antigens around the virus
            let numAntigens = antigens.length;
            for (let i = 0; i < numAntigens; i++) {
                let angle = (TWO_PI / numAntigens) * i;
                let px = cos(angle) * (size/2);
                let py = sin(angle) * (size/2);

                push();
                translate(px, py);
                rotate(angle + PI/2);
                drawAntigenShape(0, 0, size/4, antigens[i]);
                pop();
            }
            pop();
        }

        function drawAntigenShape(x, y, size, shapeType) {
            push();
            translate(x, y);
            fill(255, 100, 100);
            stroke(150, 50, 50);
            strokeWeight(2);

            switch(shapeType) {
                case 0: // Triangle
                    triangle(-size, size, size, size, 0, -size);
                    break;
                case 1: // Square
                    rect(-size, -size, size*2, size*2);
                    break;
                case 2: // Circle
                    circle(0, 0, size*2);
                    break;
                case 3: // Star
                    drawStar(0, 0, size/2, size, 5);
                    break;
                case 4: // Pentagon
                    drawPolygon(0, 0, size, 5);
                    break;
                case 5: // Hexagon
                    drawPolygon(0, 0, size, 6);
                    break;
            }
            pop();
        }

        function drawAntibody(x, y, size, shapeType) {
            push();
            translate(x, y);

            // Y-shaped antibody body
            fill(255, 200, 100);
            stroke(150, 100, 50);
            strokeWeight(2);

            // Stem
            rect(-5, 0, 10, size);

            // Arms
            line(0, 10, -size/2, -size/2);
            line(0, 10, size/2, -size/2);
            circle(-size/2, -size/2, 12);
            circle(size/2, -size/2, 12);

            // Binding site (matches antigen shape)
            push();
            translate(0, -size);
            scale(0.6);
            fill(100, 200, 255);
            drawAntigenShape(0, 0, 15, shapeType);
            pop();

            pop();
        }

        function drawStar(x, y, radius1, radius2, npoints) {
            let angle = TWO_PI / npoints;
            let halfAngle = angle / 2.0;
            beginShape();
            for (let a = -PI/2; a < TWO_PI - PI/2; a += angle) {
                let sx = x + cos(a) * radius2;
                let sy = y + sin(a) * radius2;
                vertex(sx, sy);
                sx = x + cos(a + halfAngle) * radius1;
                sy = y + sin(a + halfAngle) * radius1;
                vertex(sx, sy);
            }
            endShape(CLOSE);
        }

        function drawPolygon(x, y, radius, npoints) {
            let angle = TWO_PI / npoints;
            beginShape();
            for (let a = -PI/2; a < TWO_PI - PI/2; a += angle) {
                let sx = x + cos(a) * radius;
                let sy = y + sin(a) * radius;
                vertex(sx, sy);
            }
            endShape(CLOSE);
        }

        function drawArrow(x1, y1, x2, y2) {
            line(x1, y1, x2, y2);
            push();
            let angle = atan2(y2 - y1, x2 - x1);
            translate(x2, y2);
            rotate(angle);
            triangle(-10, -5, -10, 5, 0, 0);
            pop();
        }

        function drawButton(label, x, y, w, h, col) {
            push();

            // Check hover
            let hover = mouseX > x - w/2 && mouseX < x + w/2 &&
                       mouseY > y - h/2 && mouseY < y + h/2;

            if (hover) {
                fill(red(col) * 0.9, green(col) * 0.9, blue(col) * 0.9);
            } else {
                fill(col);
            }

            stroke(0);
            strokeWeight(2);
            rect(x - w/2, y - h/2, w, h, 10);

            fill(255);
            noStroke();
            textSize(18);
            textStyle(BOLD);
            text(label, x, y);

            pop();
        }

        function calculateVaccineEffectiveness() {
            let correctMatches = 0;
            let totalSlots = virus.antigens.length;

            for (let i = 0; i < totalSlots; i++) {
                let placedAntibody = antibodyPieces.find(p => p.placed && p.slotIndex === i);
                if (placedAntibody && placedAntibody.targetIndex === i) {
                    correctMatches++;
                }
            }

            vaccineDesign.effectiveness = Math.round((correctMatches / totalSlots) * 100);
        }

        function shapesMatch(antigenIndex, antibodyShapeIndex) {
            return virus.antigens[antigenIndex] === antibodyShapeIndex;
        }

        function updateSimulation() {
            // Spawn viruses
            if (frameCount % 30 === 0 && invadingViruses.length < 15) {
                let antigenIndex = int(random(virus.antigens.length));
                invadingViruses.push(new InvadingVirus(50, random(150, 500), antigenIndex));
            }

            // Spawn antibodies based on vaccine effectiveness
            if (frameCount % 20 === 0 && antibodies.length < vaccineDesign.effectiveness / 10) {
                for (let i = 0; i < virus.antigens.length; i++) {
                    let placedAntibody = antibodyPieces.find(p => p.placed && p.slotIndex === i);
                    if (placedAntibody && placedAntibody.targetIndex === i) {
                        antibodies.push(new SimulationAntibody(200, random(150, 500), placedAntibody.shapeType));
                    }
                }
            }
        }

        // Classes

        class AntibodyPiece {
            constructor(x, y, shapeType, targetIndex) {
                this.homeX = x;
                this.homeY = y;
                this.x = x;
                this.y = y;
                this.shapeType = shapeType;
                this.targetIndex = targetIndex;
                this.placed = false;
                this.slotIndex = -1;
                this.dragging = false;
            }

            display() {
                if (this.placed) {
                    let slotX = 480 + (this.slotIndex % 3) * 130 + 50;
                    let slotY = 200 + Math.floor(this.slotIndex / 3) * 150 + 50;
                    this.x = slotX;
                    this.y = slotY;
                }

                push();
                if (this.dragging) {
                    fill(255, 255, 150, 200);
                } else if (this.placed) {
                    if (this.targetIndex === this.slotIndex) {
                        fill(150, 255, 150, 200);
                    } else {
                        fill(255, 150, 150, 200);
                    }
                } else {
                    fill(255, 220, 150, 200);
                }
                stroke(100);
                strokeWeight(2);
                circle(this.x, this.y, 60);

                // Draw shape
                push();
                translate(this.x, this.y);
                scale(0.6);
                fill(100, 150, 255);
                drawAntigenShape(0, 0, 20, this.shapeType);
                pop();

                pop();
            }

            contains(px, py) {
                return dist(px, py, this.x, this.y) < 30;
            }

            snapToSlot(slotIndex) {
                this.placed = true;
                this.slotIndex = slotIndex;
            }

            returnHome() {
                this.placed = false;
                this.slotIndex = -1;
                this.x = this.homeX;
                this.y = this.homeY;
            }
        }

        class InvadingVirus {
            constructor(x, y, antigenIndex) {
                this.x = x;
                this.y = y;
                this.antigenIndex = antigenIndex;
                this.speed = random(1, 2);
                this.size = 30;
            }

            update() {
                this.x += this.speed;
            }

            display() {
                push();
                fill(220, 80, 80);
                stroke(150, 50, 50);
                strokeWeight(2);
                circle(this.x, this.y, this.size);

                // Draw one antigen
                let angle = frameCount * 0.05;
                let px = cos(angle) * (this.size/2);
                let py = sin(angle) * (this.size/2);

                push();
                translate(this.x + px, this.y + py);
                rotate(angle + PI/2);
                scale(0.5);
                drawAntigenShape(0, 0, 15, virus.antigens[this.antigenIndex]);
                pop();

                pop();
            }
        }

        class SimulationAntibody {
            constructor(x, y, shapeType) {
                this.x = x;
                this.y = y;
                this.shapeType = shapeType;
                this.speed = random(2, 3);
                this.attached = false;
                this.target = null;
            }

            update() {
                if (!this.attached) {
                    this.x += this.speed;
                } else if (this.target) {
                    this.x = this.target.x;
                    this.y = this.target.y;
                }
            }

            display() {
                push();
                fill(255, 200, 100);
                stroke(150, 100, 50);
                strokeWeight(2);

                // Simple Y-shape
                line(this.x, this.y, this.x - 8, this.y + 12);
                line(this.x, this.y, this.x + 8, this.y + 12);
                line(this.x, this.y, this.x, this.y - 12);
                circle(this.x, this.y - 12, 8);

                // Binding site
                push();
                translate(this.x, this.y - 18);
                scale(0.4);
                fill(100, 200, 255);
                drawAntigenShape(0, 0, 12, this.shapeType);
                pop();

                pop();
            }
        }

        // Mouse interaction

        function mousePressed() {
            // Check button clicks
            if (gameState === STATES.INTRO) {
                if (mouseX > width/2 - 125 && mouseX < width/2 + 125 &&
                    mouseY > 550 && mouseY < 610) {
                    gameState = STATES.VIRUS_LEARN;
                }
            } else if (gameState === STATES.VIRUS_LEARN) {
                if (mouseX > width/2 - 140 && mouseX < width/2 + 140 &&
                    mouseY > 615 && mouseY < 665) {
                    gameState = STATES.IMMUNE_LEARN;
                }
            } else if (gameState === STATES.IMMUNE_LEARN) {
                if (mouseX > width/2 - 140 && mouseX < width/2 + 140 &&
                    mouseY > 615 && mouseY < 665) {
                    gameState = STATES.DESIGN_PUZZLE;
                }
            } else if (gameState === STATES.DESIGN_PUZZLE) {
                // Check for dragging antibody pieces
                for (let piece of antibodyPieces) {
                    if (!piece.placed && piece.contains(mouseX, mouseY)) {
                        selectedPiece = piece;
                        selectedPiece.dragging = true;
                        dragOffset.x = selectedPiece.x - mouseX;
                        dragOffset.y = selectedPiece.y - mouseY;
                        return;
                    }
                }

                // Check for removing placed pieces
                for (let piece of antibodyPieces) {
                    if (piece.placed && piece.contains(mouseX, mouseY)) {
                        piece.returnHome();
                        return;
                    }
                }

                // Check test button
                if (vaccineDesign.effectiveness > 0 &&
                    mouseX > 465 && mouseX < 765 &&
                    mouseY > 615 && mouseY < 665) {
                    // Initialize simulation
                    simulationTime = 0;
                    virusesBlocked = 0;
                    virusesEscaped = 0;
                    invadingViruses = [];
                    antibodies = [];
                    immuneCells = [];
                    gameState = STATES.SIMULATION;
                }
            } else if (gameState === STATES.SIMULATION) {
                if (simulationTime >= 600) {
                    if (mouseX > width/2 - 100 && mouseX < width/2 + 100 &&
                        mouseY > 595 && mouseY < 645) {
                        gameState = STATES.RESULTS;
                    }
                }
            } else if (gameState === STATES.RESULTS) {
                // Try different design
                if (mouseX > width/2 - 260 && mouseX < width/2 - 40 &&
                    mouseY > 595 && mouseY < 645) {
                    gameState = STATES.DESIGN_PUZZLE;
                }
                // Restart
                if (mouseX > width/2 + 75 && mouseX < width/2 + 225 &&
                    mouseY > 595 && mouseY < 645) {
                    initializeVirus();
                    createAntibodyPieces();
                    vaccineDesign.effectiveness = 0;
                    gameState = STATES.INTRO;
                }
            }
        }

        function mouseDragged() {
            if (gameState === STATES.DESIGN_PUZZLE && selectedPiece) {
                selectedPiece.x = mouseX + dragOffset.x;
                selectedPiece.y = mouseY + dragOffset.y;
            }
        }

        function mouseReleased() {
            if (gameState === STATES.DESIGN_PUZZLE && selectedPiece) {
                selectedPiece.dragging = false;

                // Check if dropped in a slot
                for (let i = 0; i < virus.antigens.length; i++) {
                    let slotX = 480 + (i % 3) * 130 + 50;
                    let slotY = 200 + Math.floor(i / 3) * 150 + 50;

                    if (dist(mouseX, mouseY, slotX, slotY) < 50) {
                        // Check if slot is empty
                        let occupied = antibodyPieces.find(p => p.placed && p.slotIndex === i);
                        if (!occupied) {
                            selectedPiece.snapToSlot(i);
                        } else {
                            selectedPiece.returnHome();
                        }
                        selectedPiece = null;
                        return;
                    }
                }

                // Return to home if not dropped in slot
                selectedPiece.returnHome();
                selectedPiece = null;
            }
        }
    </script>
</body>
</html>
